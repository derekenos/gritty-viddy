<html lang="en">

  <head>
    <meta charset="utf-8">

    <style>
     video,
     canvas {
       width: 1280px;
       height: 720px;
       border: solid #000 1px;
       display: none;
     }

     #final-wrapper {
       display: inline-block;
       position: relative;
     }

     #final-controls {
       position: absolute;
       top: 16px;
       right: 16px;
       background-color: rgba(0, 0, 0, .5);
       color: #fff;
       font-size: 16px;
       cursor: pointer;
     }

     canvas#final {
       display: block;
     }
    </style>

    <script src="ext/gpu-browser.min.js"></script>

    <script type="module">
     import { applyPixelFilters } from "./filters.js"
     import CanvasRecorder from "./CanvasRecorder.js"
     import {
       brightnessFilter,
       thresholdFilter,
       channelFilter,
        /* colBlankerFilter,
        * colorBalanceFilter,
        * colorReducerFilter,
        * invertFilter,
        * rowBlankerFilter, */
     } from "./gpuFilters.js"

     const dumpFrameToCanvas = (video, canvas) =>
       canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height)

     function initRecordControls (button, canvas) {
       button.textContent = "Start Recording"
       const recorder = new CanvasRecorder(canvas)
       button.addEventListener("click", e => {
         switch (recorder.state) {
           case "inactive":
             recorder.start()
             e.target.textContent = "Stop Recording"
             break
           case "recording":
             recorder.stop()
             e.target.textContent = "Start Recording"
             break
           default:
             throw new Error(`Unhandled recorder state: ${recorder.state}`)
             break
         }
       })
     }

     function init () {
       // Start video stream.
       const video = document.querySelector("video")
       const width = 1280
       const height = 720
       navigator.mediaDevices
         .getUserMedia({ video: { width, height } })
         .then(stream => {
           video.srcObject = stream
         })

       const canvasScale = 1
       const workCanvas = document.querySelector("canvas#work")
       workCanvas.width = width * canvasScale
       workCanvas.height = height * canvasScale
       const workCanvasCtx = workCanvas.getContext("2d")
       const finalCanvas = document.querySelector("canvas#final")
       finalCanvas.width = width * canvasScale
       finalCanvas.height = height * canvasScale
       const finalCanvasCtx = finalCanvas.getContext("2d")

       // Add fullscreen button handler.
       document.getElementById("final-fullscreen")
         .addEventListener("click", () => {
           finalCanvas.requestFullscreen()
         })

       function getProcessedImageData (filters = []) {
         dumpFrameToCanvas(video, workCanvas)
         const ctx = workCanvas.getContext("2d")
         let imageData = ctx.getImageData(0, 0, workCanvas.width, workCanvas.height)
         imageData = applyPixelFilters(filters, imageData)
         return imageData
       }

       const filters = [
         //thresholdFilter(100),
         //channelFilter([ "r", "g" ]),
         //colorBalanceFilter(anim.linearInterpolate(0, 255), 0, 0),
         //colorReducerFilter(0b00111111),
         //rowBlankerFilter(row => row % anim.linearInterpolate(2, 64) === 0, [ 255, 255, 255, 255 ]),
         //rowBlankerFilter(row => row % 2 === 0, [ 255, 255, 255, 255 ]),
         //colBlankerFilter(row => row % anim.linearInterpolate(2, 16) === 3, [ 0, 0, 0, 255 ]),
         //invertFilter,
         thresholdFilter({ threshold: 128 }),
         brightnessFilter({ factor: 0 }),
         channelFilter({ r: true, g: true, b: true }),
       ]

       function process () {
         finalCanvasCtx.putImageData(getProcessedImageData(filters), 0, 0)
       }

       setInterval(process, 33)

       initRecordControls(
         document.getElementById("final-record"),
         document.querySelector("canvas#final")
       )
     }

     document.addEventListener("DOMContentLoaded", init)
    </script>

  </head>

  <body>
    <video autoplay="true"></video>
    <canvas id="work"></canvas>
    <div id="final-wrapper">
      <div id="final-controls">
        <button id="final-record"></button>
        <button id="final-fullscreen">&#8644;</button>
      </div>
      <canvas id="final"></canvas>
    </div>
  </body>

</html>
