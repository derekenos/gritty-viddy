<html lang="en">

  <head>
    <meta charset="utf-8">

    <style>
     video,
     canvas {
       width: calc(4 * 160px);
       height: calc(3 * 160px);
       border: solid #000 1px;
     }

     canvas#work {
       display: none;
     }
    </style>

    <script type="module">
     import { applyPixelFilters } from "./filters.js"
     import {
       brightnessFilter,
       channelFilter,
       thresholdFilter,
     } from "./pixelFilters.js"

     const dumpFrameToCanvas = (video, canvas) =>
       canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height)

     function init () {
       // Start video stream.
       const video = document.querySelector("video")
       navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
         video.srcObject = stream
       })

       const workCanvas = document.querySelector("canvas#work")
       const workCanvasCtx = workCanvas.getContext("2d")
       const finalCanvas = document.querySelector("canvas#final")
       const finalCanvasCtx = finalCanvas.getContext("2d")

       function getProcessedImageData (filters = []) {
         dumpFrameToCanvas(video, workCanvas)
         const ctx = workCanvas.getContext("2d")
         let imageData = ctx.getImageData(0, 0, workCanvas.width, workCanvas.height)
         imageData = applyPixelFilters(filters, imageData)
         return imageData
       }

       function process () {
         const filters = [
           brightnessFilter(3.0),
           channelFilter([ "r", "g" ]),
           thresholdFilter(20),
         ]
         finalCanvasCtx.putImageData(getProcessedImageData(filters), 0, 0)
       }

       setInterval(process, 33)
     }

     document.addEventListener("DOMContentLoaded", init)
    </script>

  </head>

  <body>
    <video autoplay="true"></video>
    <canvas id="work"></canvas>
    <canvas id="final"></canvas>
  </body>

</html>
