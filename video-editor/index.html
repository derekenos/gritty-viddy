<html lang="en">

  <head>
    <meta charset="utf-8">

    <style>
     video,
     canvas {
       width: 1280px;
       height: 720px;
       border: solid #000 1px;
     }

     canvas#work {
       display: none;
     }
    </style>

    <script type="module">
     import Animator from "./animator.js"
     import { applyPixelFilters } from "./filters.js"
     import {
       brightnessFilter,
       channelFilter,
       colBlankerFilter,
       colorBalanceFilter,
       colorReducerFilter,
       invertFilter,
       rowBlankerFilter,
       thresholdFilter,
     } from "./pixelFilters.js"

     const dumpFrameToCanvas = (video, canvas) =>
       canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height)

     function init () {
       // Start video stream.
       const video = document.querySelector("video")
       navigator.mediaDevices
         .getUserMedia({ video: { width: 1280, height: 720 } })
         .then(stream => {
           video.srcObject = stream
         })

       const workCanvas = document.querySelector("canvas#work")
       const workCanvasCtx = workCanvas.getContext("2d")
       const finalCanvas = document.querySelector("canvas#final")
       const finalCanvasCtx = finalCanvas.getContext("2d")

       function getProcessedImageData (filters = []) {
         dumpFrameToCanvas(video, workCanvas)
         const ctx = workCanvas.getContext("2d")
         let imageData = ctx.getImageData(0, 0, workCanvas.width, workCanvas.height)
         imageData = applyPixelFilters(filters, imageData)
         return imageData
       }

       const anim = Animator({ stepsPerCycle: 32, oneShot: true })
       function process () {
         finalCanvasCtx.putImageData(
           getProcessedImageData(
             [
               //thresholdFilter(anim.linearInterpolate(0, 100)),
               //channelFilter([ "r", "g" ]),
               //colorBalanceFilter(anim.linearInterpolate(0, 255), 0, 0),
               //colorReducerFilter(0b11000000),
               invertFilter,
               brightnessFilter(0),
               rowBlankerFilter(row => row % 2 === 0, [ 255, 255, 255, 255 ]),
               colBlankerFilter(col => col % 2 === 0, [ 255, 255, 255, 255 ]),
             ]
           ),
           0,
           0
         )
         anim.step()
       }

       setInterval(process, 16)
     }

     document.addEventListener("DOMContentLoaded", init)
    </script>

  </head>

  <body>
    <video autoplay="true"></video>
    <canvas id="work"></canvas>
    <canvas id="final"></canvas>
  </body>

</html>
